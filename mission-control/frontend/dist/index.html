<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mission Control</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bg: { DEFAULT: '#0a0a0f', 2: '#12121a', 3: '#1a1a28' },
                        border: '#2a2a3a',
                        accent: '#6366f1',
                        accentDim: '#4f46e5',
                        success: '#22c55e',
                        warn: '#eab308',
                        danger: '#ef4444',
                        muted: '#6b7280',
                    }
                }
            }
        }
    </script>
    <style>
        * { scrollbar-width: thin; scrollbar-color: #2a2a3a transparent; }
        body { background: #0a0a0f; color: #e5e7eb; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .glow { box-shadow: 0 0 24px rgba(99,102,241,0.15); }
        .fade-in { animation: fadeIn 0.2s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pulse-dot { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    </style>
</head>
<body>
    <div id="root"></div>

<script type="text/babel">
const { useState, useEffect, useCallback, useRef, useMemo } = React;

const api = {
    async get(url) {
        const r = await fetch(`/api${url}`);
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    },
    async post(url, body) {
        const r = await fetch(`/api${url}`, {
            method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    },
    async put(url, body) {
        const r = await fetch(`/api${url}`, {
            method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body)
        });
        if (!r.ok) throw new Error(`HTTP ${r.status}`);
        return r.json();
    },
};

function timeAgo(ts) {
    if (!ts) return 'never';
    const diff = Date.now() - ts;
    const mins = Math.floor(diff / 60000);
    if (mins < 1) return 'just now';
    if (mins < 60) return `${mins}m ago`;
    const hrs = Math.floor(mins / 60);
    if (hrs < 24) return `${hrs}h ago`;
    return `${Math.floor(hrs / 24)}d ago`;
}
function formatTokens(n) {
    if (!n) return '0';
    if (n >= 1000000) return `${(n/1000000).toFixed(1)}M`;
    if (n >= 1000) return `${(n/1000).toFixed(1)}K`;
    return String(n);
}
function formatCost(c) { return c ? `$${c.toFixed(4)}` : ''; }
function sessionIcon(s) {
    if (s.label) return '\u{1F527}';
    if (s.kind === 'group') return '\u{1F465}';
    if ((s.key||'').includes('subagent')) return '\u{1F916}';
    if (s.key === 'agent:main:main') return '\u{1F5A4}';
    return '\u{1F4AC}';
}
function sessionName(s) {
    if (s.label) return s.label;
    return (s.displayName || s.key || '?').replace('whatsapp:g-', '').replace('agent-main-', '').replace(/-/g, ' ');
}
function isActive(s) { return s.updatedAt && (Date.now() - s.updatedAt) < 300000; }
function modelShort(m) { return m ? m.replace('claude-','').replace('anthropic/','').replace('-20250514','') : '?'; }

function useInterval(cb, delay) {
    const ref = useRef();
    useEffect(() => { ref.current = cb; }, [cb]);
    useEffect(() => { if (delay !== null) { const id = setInterval(() => ref.current(), delay); return () => clearInterval(id); } }, [delay]);
}

function StatusDot({ active, size }) {
    return <span className={`inline-block rounded-full ${size||'w-2 h-2'} ${active ? 'bg-success pulse-dot' : 'bg-muted/50'}`} />;
}

function TopBar({ tab, setTab, connected, sessionCount }) {
    const tabs = [
        { id: 'sessions', label: 'Sessions', icon: '\u26A1' },
        { id: 'tasks', label: 'Tasks', icon: '\u{1F4CB}' },
        { id: 'cron', label: 'Cron', icon: '\u23F0' },
    ];
    return (
        <header className="bg-bg-2 border-b border-border px-4 py-3 flex items-center justify-between sticky top-0 z-50">
            <div className="flex items-center gap-6">
                <div className="flex items-center gap-2">
                    <span className="text-lg">{'\u{1F39B}'}</span>
                    <h1 className="font-bold text-lg tracking-tight">Mission Control</h1>
                </div>
                <nav className="flex gap-1">
                    {tabs.map(t => (
                        <button key={t.id} onClick={() => setTab(t.id)}
                            className={`px-3 py-1.5 rounded-md text-sm font-medium transition-all ${
                                tab === t.id ? 'bg-accent text-white' : 'text-muted hover:text-white hover:bg-bg-3'
                            }`}>
                            <span className="mr-1.5">{t.icon}</span>{t.label}
                        </button>
                    ))}
                </nav>
            </div>
            <div className="flex items-center gap-3 text-sm">
                <span className="text-muted">{sessionCount} sessions</span>
                <div className="flex items-center gap-1.5">
                    <StatusDot active={connected} />
                    <span className={connected ? 'text-success' : 'text-danger'}>
                        {connected ? 'Connected' : 'Offline'}
                    </span>
                </div>
            </div>
        </header>
    );
}

function SessionRow({ session, onSelect, selected }) {
    const active = isActive(session);
    return (
        <button onClick={() => onSelect(session)}
            className={`w-full text-left px-4 py-3 border-b border-border/50 transition-all hover:bg-bg-3 flex items-center gap-3 ${
                selected ? 'bg-bg-3 border-l-2 border-l-accent' : ''
            }`}>
            <span className="text-xl flex-shrink-0">{sessionIcon(session)}</span>
            <div className="flex-1 min-w-0">
                <div className="flex items-center gap-2">
                    <span className="font-medium truncate">{sessionName(session)}</span>
                    <StatusDot active={active} />
                </div>
                <div className="flex items-center gap-2 text-xs text-muted mt-0.5">
                    <span>{modelShort(session.model)}</span>
                    <span>{formatTokens(session.totalTokens)} tok</span>
                    <span>{timeAgo(session.updatedAt)}</span>
                </div>
            </div>
            <span className="text-xs text-muted bg-bg-3 px-1.5 py-0.5 rounded">{session.kind}</span>
        </button>
    );
}

function SessionDetail({ session }) {
    const [history, setHistory] = useState([]);
    const [loading, setLoading] = useState(false);
    const [message, setMessage] = useState('');
    const [sending, setSending] = useState(false);

    useEffect(() => {
        if (session) loadHistory();
    }, [session && session.key]);

    const loadHistory = async () => {
        setLoading(true);
        try {
            const data = await api.get(`/sessions/${encodeURIComponent(session.key)}/history?limit=20`);
            setHistory(data.messages || []);
        } catch (e) { console.error(e); }
        setLoading(false);
    };

    const sendMessage = async () => {
        if (!message.trim()) return;
        setSending(true);
        try {
            await api.post(`/sessions/${encodeURIComponent(session.key)}/send`, { message: message.trim() });
            setMessage('');
            setTimeout(loadHistory, 2000);
        } catch (e) { alert('Error: ' + e.message); }
        setSending(false);
    };

    if (!session) {
        return (
            <div className="flex-1 flex items-center justify-center text-muted">
                <div className="text-center">
                    <div className="text-4xl mb-3">{'\u{1F448}'}</div>
                    <p>Select a session to view details</p>
                </div>
            </div>
        );
    }

    const active = isActive(session);
    const pctUsed = ((session.totalTokens / (session.contextTokens || 200000)) * 100);

    return (
        <div className="flex-1 flex flex-col min-w-0">
            <div className="bg-bg-2 border-b border-border px-5 py-4">
                <div className="flex items-center justify-between">
                    <div>
                        <div className="flex items-center gap-2">
                            <span className="text-xl">{sessionIcon(session)}</span>
                            <h2 className="text-lg font-semibold">{sessionName(session)}</h2>
                            <StatusDot active={active} size="w-2.5 h-2.5" />
                        </div>
                        <div className="mt-1">
                            <span className="font-mono text-xs bg-bg-3 px-2 py-0.5 rounded text-muted">{session.key}</span>
                        </div>
                    </div>
                    <div className="text-right text-sm space-y-0.5">
                        <div className="text-muted">Model: <span className="text-white">{modelShort(session.model)}</span></div>
                        <div className="text-muted">Tokens: <span className="text-white">{formatTokens(session.totalTokens)}</span></div>
                        <div className="text-muted">Context: <span className="text-white">{formatTokens(session.contextTokens)}</span></div>
                    </div>
                </div>
                <div className="mt-3">
                    <div className="h-1.5 bg-bg-3 rounded-full overflow-hidden">
                        <div className="h-full bg-accent rounded-full transition-all" style={{width: `${Math.min(100, pctUsed)}%`}} />
                    </div>
                    <div className="text-xs text-muted mt-1">{pctUsed.toFixed(1)}% context used</div>
                </div>
            </div>

            <div className="flex-1 overflow-auto p-4 space-y-3">
                {loading && <div className="text-center text-muted py-8">Loading history...</div>}
                {!loading && history.length === 0 && <div className="text-center text-muted py-8">No messages in history</div>}
                {history.map((msg, i) => {
                    let text = '';
                    let hasTools = false;
                    if (typeof msg.content === 'string') { text = msg.content; }
                    else if (Array.isArray(msg.content)) {
                        const parts = [];
                        msg.content.forEach(c => {
                            if (c.type === 'text' && c.text) parts.push(c.text);
                            if (c.type === 'toolCall') hasTools = true;
                        });
                        text = parts.join('\n');
                    }
                    if (!text && !hasTools) return null;
                    const isUser = msg.role === 'user';
                    const cost = msg.usage && msg.usage.cost && msg.usage.cost.total;
                    return (
                        <div key={i} className={`fade-in ${isUser ? 'flex justify-end' : ''}`}>
                            <div className={`max-w-[85%] rounded-lg px-4 py-2.5 ${
                                isUser ? 'bg-accent/20 border border-accent/30' : 'bg-bg-3 border border-border'
                            }`}>
                                <div className="flex items-center gap-2 mb-1">
                                    <span className="text-xs font-medium">{isUser ? '\u{1F464} User' : '\u{1F916} Assistant'}</span>
                                    {msg.timestamp && <span className="text-xs text-muted">{timeAgo(msg.timestamp)}</span>}
                                    {cost > 0 && <span className="text-xs text-muted">{formatCost(cost)}</span>}
                                    {hasTools && !text && <span className="text-xs text-muted italic">{'\u{1F527}'} tools</span>}
                                </div>
                                {text && <div className="text-sm whitespace-pre-wrap break-words">{text.slice(0, 2000)}{text.length > 2000 ? '...' : ''}</div>}
                                {hasTools && !text && <div className="text-xs text-muted italic">Using tools...</div>}
                            </div>
                        </div>
                    );
                })}
            </div>

            <div className="border-t border-border p-4 bg-bg-2">
                <div className="flex gap-2">
                    <input value={message} onChange={e => setMessage(e.target.value)}
                        onKeyDown={e => { if (e.key === 'Enter' && !e.shiftKey) sendMessage(); }}
                        placeholder={`Message ${sessionName(session)}...`}
                        className="flex-1 bg-bg-3 border border-border rounded-lg px-4 py-2.5 text-sm focus:outline-none focus:border-accent"
                        disabled={sending} />
                    <button onClick={sendMessage} disabled={sending || !message.trim()}
                        className="bg-accent hover:bg-accentDim disabled:opacity-40 text-white px-5 py-2.5 rounded-lg text-sm font-medium transition-all">
                        {sending ? '...' : 'Send'}
                    </button>
                </div>
                <div className="flex items-center justify-between mt-2">
                    <span className="text-xs text-muted">Enter to send</span>
                    <button onClick={loadHistory} className="text-xs text-accent hover:underline">{'\u21BB'} Refresh</button>
                </div>
            </div>
        </div>
    );
}

function SessionsPage({ sessions }) {
    const [selected, setSelected] = useState(null);
    useEffect(() => { if (!selected && sessions.length > 0) setSelected(sessions[0]); }, [sessions]);
    const currentSession = useMemo(() => {
        if (!selected) return null;
        return sessions.find(s => s.key === selected.key) || selected;
    }, [sessions, selected && selected.key]);
    return (
        <div className="flex h-[calc(100vh-57px)]">
            <div className="w-80 flex-shrink-0 border-r border-border overflow-auto bg-bg">
                <div className="px-4 py-3 border-b border-border">
                    <h3 className="text-sm font-medium text-muted uppercase tracking-wider">Active Sessions</h3>
                </div>
                {sessions.map(s => (
                    <SessionRow key={s.key} session={s} onSelect={setSelected} selected={selected && selected.key === s.key} />
                ))}
                {sessions.length === 0 && <div className="p-8 text-center text-muted text-sm">No sessions</div>}
            </div>
            <SessionDetail session={currentSession} />
        </div>
    );
}

function TaskCard({ task, onMove, onDelete }) {
    const statuses = ['backlog', 'in_progress', 'review', 'done'];
    const idx = statuses.indexOf(task.status);
    const pColor = { urgent: 'text-danger', high: 'text-orange-400', medium: 'text-warn', low: 'text-muted' };
    return (
        <div className="bg-bg-2 border border-border rounded-lg p-3 fade-in hover:border-accent/40 transition-all">
            <div className="flex items-start justify-between mb-2">
                <h4 className="font-medium text-sm">{task.title}</h4>
                <span className={`text-xs px-1.5 py-0.5 rounded ${pColor[task.priority] || 'text-muted'}`}>{task.priority}</span>
            </div>
            {task.description && <p className="text-xs text-muted mb-2 line-clamp-2">{task.description}</p>}
            <div className="flex items-center justify-between text-xs text-muted">
                <span>{timeAgo(new Date(task.createdAt).getTime())}</span>
                <div className="flex gap-1">
                    {idx > 0 && <button onClick={() => onMove(task.id, statuses[idx-1])} className="hover:text-white px-1">{'\u2190'}</button>}
                    {idx < 3 && <button onClick={() => onMove(task.id, statuses[idx+1])} className="hover:text-white px-1">{'\u2192'}</button>}
                    <button onClick={() => onDelete(task.id)} className="hover:text-danger px-1 ml-1">{'\u00D7'}</button>
                </div>
            </div>
        </div>
    );
}

function TasksPage() {
    const [tasks, setTasks] = useState([]);
    const [showAdd, setShowAdd] = useState(false);
    const [newTitle, setNewTitle] = useState('');
    const [newDesc, setNewDesc] = useState('');
    const [newPriority, setNewPriority] = useState('medium');

    useEffect(() => { loadTasks(); }, []);
    const loadTasks = async () => {
        try { const d = await api.get('/tasks'); setTasks(d.tasks || []); } catch (e) { console.error(e); }
    };
    const addTask = async () => {
        if (!newTitle.trim()) return;
        try {
            await api.post('/tasks', { title: newTitle, description: newDesc, priority: newPriority });
            setNewTitle(''); setNewDesc(''); setShowAdd(false); loadTasks();
        } catch (e) { alert('Error: ' + e.message); }
    };
    const moveTask = async (id, newStatus) => {
        const updated = tasks.map(t => t.id === id ? { ...t, status: newStatus, updatedAt: new Date().toISOString() } : t);
        setTasks(updated);
        try { await api.put('/tasks', { tasks: updated, nextId: Math.max(...tasks.map(t => t.id), 0) + 1 }); }
        catch (e) { loadTasks(); }
    };
    const deleteTask = async (id) => {
        const updated = tasks.filter(t => t.id !== id);
        setTasks(updated);
        try { await api.put('/tasks', { tasks: updated, nextId: Math.max(...tasks.map(t => t.id), 0) + 1 }); }
        catch (e) { loadTasks(); }
    };

    const columns = [
        { id: 'backlog', label: 'Backlog', icon: '\u{1F4E5}', color: 'border-t-gray-500' },
        { id: 'in_progress', label: 'In Progress', icon: '\u{1F528}', color: 'border-t-indigo-500' },
        { id: 'review', label: 'Review', icon: '\u{1F440}', color: 'border-t-yellow-500' },
        { id: 'done', label: 'Done', icon: '\u2705', color: 'border-t-green-500' },
    ];

    return (
        <div className="p-6 h-[calc(100vh-57px)] overflow-auto">
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold">Task Board</h2>
                <button onClick={() => setShowAdd(!showAdd)}
                    className="bg-accent hover:bg-accentDim text-white px-4 py-2 rounded-lg text-sm font-medium transition-all">
                    + New Task
                </button>
            </div>
            {showAdd && (
                <div className="bg-bg-2 border border-border rounded-lg p-4 mb-6 fade-in">
                    <input value={newTitle} onChange={e => setNewTitle(e.target.value)} placeholder="Task title..." autoFocus
                        className="w-full bg-bg-3 border border-border rounded px-3 py-2 text-sm mb-2 focus:outline-none focus:border-accent" />
                    <textarea value={newDesc} onChange={e => setNewDesc(e.target.value)} placeholder="Description (optional)..."
                        className="w-full bg-bg-3 border border-border rounded px-3 py-2 text-sm mb-2 h-20 resize-none focus:outline-none focus:border-accent" />
                    <div className="flex items-center gap-3">
                        <select value={newPriority} onChange={e => setNewPriority(e.target.value)}
                            className="bg-bg-3 border border-border rounded px-3 py-2 text-sm focus:outline-none">
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                            <option value="urgent">Urgent</option>
                        </select>
                        <button onClick={addTask} className="bg-accent hover:bg-accentDim text-white px-4 py-2 rounded text-sm">Create</button>
                        <button onClick={() => setShowAdd(false)} className="text-muted hover:text-white px-3 py-2 text-sm">Cancel</button>
                    </div>
                </div>
            )}
            <div className="grid grid-cols-4 gap-4">
                {columns.map(col => {
                    const colTasks = tasks.filter(t => t.status === col.id);
                    return (
                        <div key={col.id} className={`bg-bg-2 rounded-lg border border-border border-t-2 ${col.color}`}>
                            <div className="px-3 py-2.5 border-b border-border flex items-center justify-between">
                                <div className="flex items-center gap-2">
                                    <span>{col.icon}</span>
                                    <span className="text-sm font-medium">{col.label}</span>
                                </div>
                                <span className="text-xs text-muted bg-bg-3 px-2 py-0.5 rounded-full">{colTasks.length}</span>
                            </div>
                            <div className="p-2 space-y-2 min-h-[200px]">
                                {colTasks.map(t => <TaskCard key={t.id} task={t} onMove={moveTask} onDelete={deleteTask} />)}
                                {colTasks.length === 0 && <div className="text-center text-muted text-xs py-8 opacity-50">Empty</div>}
                            </div>
                        </div>
                    );
                })}
            </div>
        </div>
    );
}

function CronPage() {
    const [jobs, setJobs] = useState([]);
    const [loading, setLoading] = useState(true);
    useEffect(() => { loadJobs(); }, []);
    const loadJobs = async () => {
        setLoading(true);
        try { const d = await api.get('/cron'); setJobs(d.jobs || []); } catch (e) { console.error(e); }
        setLoading(false);
    };
    if (loading) return <div className="p-8 text-center text-muted">Loading cron jobs...</div>;
    return (
        <div className="p-6 h-[calc(100vh-57px)] overflow-auto">
            <div className="flex items-center justify-between mb-6">
                <h2 className="text-2xl font-bold">Cron Jobs</h2>
                <button onClick={loadJobs} className="text-sm text-accent hover:underline">{'\u21BB'} Refresh</button>
            </div>
            {jobs.length === 0 && (
                <div className="text-center text-muted py-12">
                    <div className="text-4xl mb-3">{'\u23F0'}</div>
                    <p>No cron jobs configured</p>
                </div>
            )}
            <div className="space-y-3">
                {jobs.map(job => (
                    <div key={job.id} className="bg-bg-2 border border-border rounded-lg p-4 hover:border-accent/40 transition-all">
                        <div className="flex items-center justify-between mb-2">
                            <div className="flex items-center gap-3">
                                <span className={`w-2.5 h-2.5 rounded-full ${job.enabled ? 'bg-success' : 'bg-muted/50'}`} />
                                <h3 className="font-semibold">{job.name || (job.id||'').slice(0,8)}</h3>
                                <span className="text-xs text-muted bg-bg-3 px-2 py-0.5 rounded font-mono">
                                    {job.schedule && job.schedule.expr || (job.schedule && job.schedule.kind) || '?'}
                                </span>
                            </div>
                            <span className={`text-xs px-2 py-0.5 rounded ${job.enabled ? 'bg-success/20 text-success' : 'bg-muted/20 text-muted'}`}>
                                {job.enabled ? 'Enabled' : 'Disabled'}
                            </span>
                        </div>
                        {job.payload && job.payload.text && <p className="text-sm text-muted mb-3 line-clamp-2">{job.payload.text}</p>}
                        <div className="flex items-center gap-4 text-xs text-muted flex-wrap">
                            <span>Target: <span className="text-white">{job.sessionTarget || '?'}</span></span>
                            <span>Mode: <span className="text-white">{job.wakeMode || '?'}</span></span>
                            {job.state && job.state.nextRunAtMs && <span>Next: <span className="text-white">{new Date(job.state.nextRunAtMs).toLocaleString()}</span></span>}
                            {job.state && job.state.lastStatus && <span>Last: <span className={job.state.lastStatus === 'ok' ? 'text-success' : 'text-danger'}>{job.state.lastStatus}</span></span>}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function App() {
    const [tab, setTab] = useState('sessions');
    const [sessions, setSessions] = useState([]);
    const [connected, setConnected] = useState(false);

    const loadSessions = useCallback(async () => {
        try {
            const data = await api.get('/sessions?limit=30');
            setSessions(data.sessions || []);
            setConnected(true);
        } catch (e) { setConnected(false); }
    }, []);

    useEffect(() => { loadSessions(); }, []);
    useInterval(loadSessions, 15000);

    return (
        <div className="h-screen flex flex-col bg-bg">
            <TopBar tab={tab} setTab={setTab} connected={connected} sessionCount={sessions.length} />
            {tab === 'sessions' && <SessionsPage sessions={sessions} />}
            {tab === 'tasks' && <TasksPage />}
            {tab === 'cron' && <CronPage />}
        </div>
    );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<App />);
</script>
</body>
</html>
